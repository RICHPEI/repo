name: Claude on Issue Comment

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  claude:
    if: contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest

    steps:
      - name: Read issue and comment
        run: |
          python <<'PY'
          import json, os
          event = json.load(open(os.environ["GITHUB_EVENT_PATH"], "r", encoding="utf-8"))
          issue = event["issue"]
          comment = event["comment"]

          prompt = f"""
          你是一位資深前端工程師，請根據以下 GitHub Issue 與留言，
          產出可實作的 React + TypeScript + Tailwind CSS 登入功能。

          【Issue 標題】
          {issue["title"]}

          【Issue 描述】
          {issue.get("body","")}

          【使用者留言】
          {comment["body"]}

          請提供：
          1. 元件結構說明
          2. React + TypeScript 程式碼範例
          3. JWT 登入流程說明
          4. POST /api/auth/login 呼叫範例
          5. 基本錯誤處理
          """
          open("prompt.txt","w",encoding="utf-8").write(prompt)
          PY

      - name: Call Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set -euo pipefail

          # 確認有帶到 secret（不外洩內容）
          echo "KEY_LEN=${#ANTHROPIC_API_KEY}"
          echo -n "$ANTHROPIC_API_KEY" | sha256sum | awk '{print "KEY_SHA256="$1}'

          # 清掉可能的換行/CR（很多人是複製貼上帶到）
          ANTHROPIC_API_KEY="$(printf "%s" "$ANTHROPIC_API_KEY" | tr -d '\r\n')"

          python - <<'PY'
          import json
          prompt = open("prompt.txt","r",encoding="utf-8").read()
          
          payload = {
          "model": "claude-sonnet-4-5-20250929",
          "max_tokens": 800,
          "messages": [{"role":"user","content": prompt}]
          }

          open("payload.json","w",encoding="utf-8").write(json.dumps(payload, ensure_ascii=False))
          PY

          curl -sS https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "anthropic-version: 2023-06-01" \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -d @payload.json > response.json

          echo "=== response.json ==="
          cat response.json
          echo "=== end response.json ==="

          python - <<'PY'
          import json, sys
          r = json.load(open("response.json","r",encoding="utf-8"))
          if r.get("type") == "error":
            print("Claude API error:", r)
            sys.exit(1)
          text = r["content"][0]["text"]
          open("answer.txt","w",encoding="utf-8").write(text)
          PY

      - name: Reply to GitHub Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<'PY'
          import json, os, urllib.request
          repo = os.environ["GITHUB_REPOSITORY"]
          issue_number = os.environ["GITHUB_EVENT_PATH"]

          event = json.load(open(issue_number, "r", encoding="utf-8"))
          num = event["issue"]["number"]

          body = open("answer.txt","r",encoding="utf-8").read()
          data = json.dumps({"body": body}).encode("utf-8")

          req = urllib.request.Request(
            f"https://api.github.com/repos/{repo}/issues/{num}/comments",
            data=data,
            headers={
              "Authorization": f"Bearer {os.environ['GH_TOKEN']}",
              "Accept": "application/vnd.github+json",
              "Content-Type": "application/json",
              "User-Agent": "github-actions"
            },
            method="POST"
          )
          with urllib.request.urlopen(req) as resp:
            print("Posted comment:", resp.status)
          PY
